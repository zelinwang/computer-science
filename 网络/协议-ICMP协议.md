# ICMP协议

## 一、概念

**ICMP协议是网络层协议。**ICMP（Internet Control Message Protocol）Internet控制报文协议。它是TCP/IP协议簇的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。

ICMP使用IP的基本支持，就像它是一个更高级别的协议，但是，ICMP实际上是IP的一个组成部分，必须由每个IP模块实现。 

## 二、功能

**主要的功能包括：**

1. 确认 IP 包是否成功送达目标地址。
2. 报告发送过程中 IP 包被废弃的原因和改善网络设置。

## 三、报文格式

ICMP报文包含在IP数据报中，IP报头在ICMP报文的最前面。一个ICMP报文包括IP报头（至少20字节）、ICMP报头（至少八字节）和ICMP报文（属于ICMP报文的数据部分）。当IP报头中的协议字段值为1时，就说明这是一个ICMP报文。ICMP报头如下图所示。
![](E:\Code\复习心得\res\picture\ICMP的报文格式.png)

**字段说明**

|  类型  |                             说明                             |
| :----: | :----------------------------------------------------------: |
|  类型  | 占一字节，标识ICMP报文的类型，从类型值来看ICMP报文可以分为两大类。第一类是取值为1~127的差错报文，第2类是取值128以上的信息报文 |
|  代码  | 占一字节，标识对应ICMP报文的代码。它与类型字段一起共同标识了ICMP报文的详细类型 |
| 校验和 | 这是对包括ICMP报文数据部分在内的整个ICMP数据报的校验和，以检验报文在传输过程中是否出现了差错（其计算方法与在我们介绍IP报头中的校验和计算方法是一样的） |

## 三、报文说明

ICMP大概分为两类报文：一类是通知出错原因 ；一类是用于诊断查询。

### 常见报文

**相应请求**：我们用的ping操作中就包括了相应请求（类型字段值为8）和应答（类型字段值为0）ICMP报文。

> 过程：
> 一台主机向一个节点发送一个类型字段值为8的ICMP报文，如果途中没有异常（如果没有被路由丢弃，目标不回应ICMP或者传输失败），则目标返回类型字段值为0的ICMP报文，说明这台主机存在。

**目标不可达，源抑制和超时报文：**这三种报文的格式是一样的。

> - 目标不可到达报文（类型值为3）在路由器或者主机不能传递数据时使用。例如：我们要连接对方一个不存在的系统端口（端口号小于1024）时，将返回类型字段值3、代码字段值为3的ICMP报文。**常见的不可到达类型还有网络不可到达（代码字段值为0）、主机不可达到（代码字段值为1）、协议不可到达（代码字段值为2）等等**。
> - 源抑制报文（类型字段值为4，代码字段值为0）则充当一个控制流量的角色，通知主机减少数据报流量。由于ICMP没有回复传输的报文，所以只要停止该报文，主机就会逐渐恢复传输速率。
> - 无连接方式网络的问题就是数据报会丢失，或者长时间在网络游荡而找不到目标，或者拥塞导致主机在规定的时间内无法重组数据报分段，这时就要触发ICMP超时报文的产生。

**时间戳请求：**时间戳请求报文（类型值字段13）和时间戳应答报文（类型值字段14）用于测试两台主机之间数据报来回一次的传输时间。
传输时，主机填充原始时间戳，接受方收到请求后填充接受时间戳后以类型值字段14的报文格式返回，发送方计算这个时间差。

## 四、应用（ping）

ping 是基于 ICMP 协议工作的。

### 1）ping命令的功能

1. 能验证网络的连通性
2. 会统计响应时间和TTL(IP包中的Time To Live，生存周期)

那么如何验证的呢？

1. ping命令会先发送一个 ICMP Echo Request给对端
2. 对端接收到之后, 会返回一个ICMP Echo Reply
3. 若没有返回，就是超时了，会认为指定的网络地址不存在。

问题：
telnet是23端口，ssh是22端口，那么ping是什么端口?
答：ping命令是基于ICMP，是在网络层。
而端口号，是传输层的内容。所以在ICMP中根本就不关注端口号这样的信息。

### 2）ping的流程

1. ping执行命令，源主机构建一个ICMP的**回送请求消息**数据包。类型为8，内容还有序号。
2. 不停的发送请求数据包，序号每次都会+1，同时为了计算往返时间**RTT**，在报文的数据部分插入发送时间。
3. ICMP协议将数据包以及**目标IP**交给IP层，IP层将目标IP作为**目的地址**，将本机IP作为**源地址**，**协议字段置为1**，加上其他信息，构成IP数据包。
4. 接下来加入**MAC**头，首先在**本地的ARP表**中找出目标IP对应的MAC地址，找不到通过**ARP协议**查询MAC地址，找到之后，将**目标MAC地址**，**本机MAC地址**，**IP数据包**及其他数据打包发送出去。
5. 目标主机获取数据帧之后，首先检测**MAC 地址**，与自己的符合，就接收，否则丢弃。
6. 接收后检查该数据帧，将 IP数据包从帧中提取出来，交给本机的 IP 层。同样，IP层检查后，将有用的信息提取后交给**ICMP协议**。
7. 目标主机会构造一个ICMP回送响应消息数据包，回送响应数据包的**类型**字段为0，**序号**为接收到的请求数据包中的序号，然后再发送出去给源主机。
8. 在规定的时候间内，源主机如果没有接到 ICMP 的应答包，则说明目标主机不可达；如果接收到了 ICMP 回送响应消息，则说明目标主机可达。此时，源主机会检查，用当前时刻减去该数据包最初从源主机上发出的时刻，就是 ICMP 数据包的时间延迟。

针对上面发送的事情，总结成了如下图：

![](E:\Code\复习心得\res\picture\ping流程.jpg)