# TCP滑动窗口（流量控制）

在确认应答机制中，对每一个发送的数据段，都要给一个ACK确认应答，收到ACK后再发送下一个数据段。这样做有一个比较大的缺点，就是性能较差。尤其是数据往返时间较长的时候。为了可以一次性发送多个数据，引入了滑动窗口。

**滑动窗口协议（Sliding Window Protocol），属于TCP协议的一种应用，用于网络数据传输时的流量控制，以避免拥塞的发生。该协议允许发送方在停止并等待确认前发送多个数据分组。由于发送方不必每发一个分组就停下来等待确认，因此该协议可以加速数据的传输，提高网络吞吐量。**

## 一、窗口类型

- **接收端窗口rwnd（recv window）**：接收端缓冲区大小。接收端将此窗口值放在 TCP 报文的首部中的窗口字段，传送给发送端；
- **拥塞窗口cwnd（congestion window）**：发送端缓冲区大小；
- **发送端窗口swnd（send window）**：发送窗口的上限值 = Min [rwnd, cwnd]。

## 二、实际使用

如果发送方把数据发送得过快，接收方可能会来不及接收，这就会造成数据的丢失。所谓的流量控制就是让发送方的发送速率不要太快，让接收方来得及接收。**利用滑动窗口机制可以很方便的在TCP连接上实现对发送方的流量控制**。

场景如下，Client和Server在建立连接时，Server告诉Client，接收窗口为400，此时Client的发送窗口不能超过400，下图表示一个流量控制的过程

![](E:\Code\复习心得\res\picture\流量控制过程图.png)

如图，A表示Client，B表示Server，在这个过程中，Server一共进行了三次流量控制。第一次rwnd设置为300，第二次rwnd设置为100，第三次rwnd设置为0。这时Client的send为0，不再发数据给Server。Server在向Client发送报文时都设置ACK为1，只有在ACK=1时确认号字段才有意义。
TCP为每一个连接设有一个持续计时器。只要TCP连接的一方收到对方的零窗口通知就启动持续计时器。若持续计时器设置的时间到期，就发送一个零窗口探测报文段（携有1字节的数据），那么收到这个报文段的一方就重新设置持续计时器。

TCP连接的每一方都有固定大小的缓冲空间，TCP的接收端只允许发送端发送接收端缓冲区能接纳的数据。当接收方来不及处理发送方的数据，能提示发送方降低发送的速率，防止包丢失。TCP使用的流量控制协议是可变大小的滑动窗口协议。

接收方有即时窗口（滑动窗口），随ACK报文发送。 

接收端在接收到数据后，对其进行处理。如果发送端的发送速度太快，导致接收端的结束缓冲区很快的填充满了。此时如果发送端仍旧发送数据，那么接下来发送的数据都会丢包，继而导致丢包的一系列连锁反应，如超时重传等。而TCP根据接收端对数据的处理能力，决定发送端的发送速度，这个机制就是流量控制。 

## 三、接收窗口大小

在TCP协议的报头信息当中，有一个16位字段的窗口大小。在介绍这个窗口大小时我们知道，窗口大小的内容实际上是接收端接收数据缓冲区的剩余大小。这个数字越大，证明接收端接收缓冲区的剩余空间越大，网络的吞吐量越大。接收端会在确认应答发送ACK报文时，将自己的即时窗口大小填入，并跟随ACK报文一起发送过去。而发送方根据ACK报文里的窗口大小的值的改变进而改变自己的发送速度。如果接收到窗口大小的值为0，那么发送方将停止发送数据。并定期的向接收端发送窗口探测数据段，让接收端把窗口大小告诉发送端。 

**注：16位的窗口大小最大能表示65535个字节（64K），但是TCP的窗口大小最大并不是64K。在TCP首部中40个字节的选项中还包含了一个窗口扩大因子M，实际的窗口大小就是16为窗口字段的值左移M位。每移一位，扩大两倍。**

### 四、传输效率

TCP的数据传输分为交互数据流和成块数据流，交互数据流一般是一些交互式应用程序的命令，所以这些数据很小，而考虑到TCP报头和IP报头的总和就有40字节，如果数据量很小的话，那么网络的利用效率就较低。

数据传输使用**Nagle**算法，Nagle算法很简单，就是规定一个TCP连接最多只能有一个未被确认的未完成的小分组。在该分组的确认到达之前不能发送其他的小分组。但是也要考虑另一个问题，叫做糊涂窗口综合症。当接收方的缓存已满的时候，交互应用程序一次只从缓存中读取一个字节（这时候缓存中腾出一个字节），然后向发送方发送确认信息，此时发送方再发送一个字节（收到的窗口大小为1），这样网络的效率很低。所以要解决这个问题，可以让接收方等待一段时间，使得接收缓存已有最够的空间容纳一个最长报文段，或者等到接收缓存已有一半的空间。只要这两种情况出现一种，就发送确认报文，同时发送方可以把数据积累成大的报文段发送。
