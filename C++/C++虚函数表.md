## 一、简介

**多态**简单点说“一个接口，多种实现”，就是同一种事物表现出的多种形态。C++的多态分为静态多态与动态多态；**静态多态**就是函数重载和运算符重载，因为在编译期就可以确定函数地址，所以称为静态多态。**动态多态**就是通过继承重写基类的虚函数实现的多态，因为是在运行时在虚函数表中寻找调用函数的地址，所以称为动态多态。

C++中的虚函数的作用主要是实现了多态的机制。关于多态，简而言之就是用父类型别的指针指向其子类的实例，然后通过父类的指针调用实际子类的成员函数。这种技术可以让父类的指针有“多种形态”，这是一种泛型技术。所谓泛型技术，说白了就是试图使用不变的代码来实现可变的算法。比如：模板技术，RTTI技术，虚函数技术，要么是试图做到在编译时决议，要么试图做到运行时决议。

##  二、虚函数表

虚函数（Virtual Function）是通过一张虚函数表（Virtual Table）来实现的。简称为V-Table。在这个表中，表示一个类的虚函数的地址表，这张表解决了继承、覆盖的问题，保证其真实反应实际的函数。这样，在有虚函数的类的实例中这个表被分配在了这个实例的内存中，所以，当我们用父类的指针来操作一个子类的时候，这张虚函数表就显得由为重要了，它就像一个地图一样，指明了实际所应该调用的函数。值得注意的是，**虚函数表是类之间共享的，并不是每个对象都有单独的虚函数表**。C++的编译器应该是保证虚函数表的指针存在于对象实例中最前面的位置（这是为了保证取到虚函数表的有最高的性能—如果有多层继承或是多重继承的情况下）。 这意味着我们通过对象实例的地址得到这张虚函数表，然后就可以遍历其中函数指针，并调用相应的函数。**虚函数的前四个字节储存的是类的信息**

## 三、虚函数问题

### 一）构造函数可以是虚函数吗

不可以，虚函数需要对象的虚表指针访问虚表调用，虚表指针必须实例化对象才会存在，没有构造函数就不能实例化，逻辑不通。

### 二）虚函数表的存放地址

C/C++程序所占用的内存一共有5个，分别是栈区，堆区，程序代码区，全局数据区(静态区)，文字常量区。虚函数表存放在全局数据区。

### 三）虚函数表指针的位置

虚函数表是编译器来选择实现的，编译器的种类不同，可能实现方式不一样，就像前面我们说的vptr在一个对象的最前面，但是也有其他实现方式，不过目前gcc 和微软的编译器都是将vptr放在对象内存布局的最前面。

### 四）不能声明为虚函数的函数

常见的不能设置为虚函数的函数有：**内联函数，构造函数，普通函数（非类成员函数），静态函数，友元函数**。

1. 内联函数：内联函数是在编译器就进行代码展开，而虚函数实在运行期才确定运行哪个函数，这本身就是矛盾的。

2. 构造函数：虚函数表指针产生的时期是在对象被实例化的时候，如果构造函数是虚函数，实例化的时候是找不到虚函数表的指针。造成悖论，产生了先有鸡还是先有蛋的问题。

3. 普通函数：普通函数（非类成员函数）只能被重载，不能被重写。

4. 静态函数：一个类只有一份静态函数代码，所有对象共享代码，没有进行动态绑定的必要。

5. 友元函数：C++不支持友元函数的继承


### 五）析构函数为什么要定义为虚函数

防止内存泄漏，比如使用基类指针表示派生类对象，派生类对象中进行了动态分配内存，则只会调用基类的析构函数，不会对派生类的内存进行释放，造成了内存泄漏。

## 四、RTTI

RTTI是运行时类型识别的简称。

C++有三个支持RTTI的元素，分别是dynamic_cast，typeid，typeInfo三种。注意：RTTI只适用于含有虚函数的类。

## 五、继承下的虚函数表

小米的一次面试中，面试官出了一道题，计算虚函数表的大小，代码如下

```c++
class A
{
public:
    A(){}
    virtual void A1(){}
    virtual void A2(){}

    //int a;
};

class B
{
public:
    B(){}
    virtual void B1(){}
    virtual void B2(){}
};

class OA : public A
{
public:
    OA(){}
    virtual void O1(){}
    virtual void O2(){}

    //int oa;
};

OA oa；
sizeof(oa);

```

## 六、虚函数及虚函数表的创建时间

虚函数表是类所属，在编译器就生成了，并且存放在全局数据区；

虚函数表指针vptr是类对象所有，对象new的时候，由编译器对vptr进行创建并赋值。（所以构造函数不能为虚函数，否则构造的时候编译器找不到地址）

## 七、类大小

含有虚函数的空类大小为4字节。

一个对象，如果它的类有多个基类则有多个虚函数表指针（注意是两个虚函数表指针，而不是两个虚函数表）；
在多继承中，对应各个基类的vptr按继承顺序依次放置在类的内存空间中，且子类与第一个基类共用一个vptr(第二个基类有自己的vptr);
