# new和malloc的区别

## 一、属性

**new/delete**是C++关键字，需要编译器支持。**malloc/free**是库函数，需要头文件支持。

## 二、参数

使用**new**操作符申请内存分配时无须指定内存块的大小，编译器会根据类型信息自行计算。而**malloc**则需要显式地指出所需内存的尺寸。

## 三、返回类型

**new**操作符内存分配成功时，返回的是对象类型的指针，类型严格与对象匹配，无须进行类型转换，故new是符合类型安全性的操作符。而malloc内存分配成功则是返回void * ，需要通过强制类型转换将void*指针转换成我们需要的类型。

new在分配内存的时候，可能会由于自由存储区空间不足，造成抛出异常bad_alloc的问题，为了避免这种问题，可以采用nothrow关键字来进行修饰。

```c++
int* p = new(nothrow) int;
```

**加一个new_handler**

但是注意不要直接改全部的，最好在自定义的operator new里面来加：

在operator new中做如下事情：

1、首先调用标准的set_new_handler，自定义专属类的处理函数

2、调用global operator new，执行实际的内存分配。如果内存分配失败，刚才被安装的new_handler将被调用。

3、无论new成功还是失败，都必须在类自定义的operator new结束前恢复全局new_handler

## 四、分配失败

**new**内存分配失败时，会抛出**bac_alloc**异常。**malloc**分配内存失败时返回NULL。

## 五、自定义类型

new会先调用operator new函数，申请足够的内存（通常底层使用malloc实现）。然后调用类型的构造函数，初始化成员变量，最后返回自定义类型指针。delete先调用析构函数，然后调用operator delete函数释放内存（通常底层使用free实现）。

 malloc/free是库函数，只能动态的申请和释放内存，无法强制要求其做自定义类型对象构造和析构工作。

## 六、重载

C++允许重载new/delete操作符，特别的，new的就不需要为对象分配内存，而是指定了一个地址作为内存起始区域，new在这段内存上为对象调用构造函数完成初始化工作，并返回此地址。而malloc不允许重载。

## 七、申请内存的区域

new操作符从自由存储区（free store）上为对象动态分配内存空间，而malloc函数从堆上动态分配内存。自由存储区是C++基于new操作符的一个抽象概念，**凡是通过new操作符进行内存申请，该内存即为自由存储区**。而堆是操作系统中的术语，是操作系统所维护的一块特殊内存，用于程序的内存动态分配，C语言使用malloc从堆上分配内存，使用free释放已分配的对应内存。自由存储区不等于堆，如上所述，布局new就可以不位于堆中。

那么自由存储区是否能够是堆（问题等价于new是否能在堆上动态分配内存），这取决于operator new 的实现细节。自由存储区不仅可以是堆，还可以是静态存储区，这都看operator new在哪里为对象分配内存。

特别的，new甚至可以不为对象分配内存！定位new的功能可以办到这一点：

```c++
new(place_address) type
```

place_address为一个指针，代表一块内存的地址。当使用上面这种仅以一个地址调用new操作符时，new操作符调用特殊的operator new，也就是下面这个版本：

```c++
void *operator new(size_t, void*)
```

这个operator new不分配任何的内存，它只是简单地返回指针实参，然后右new表达式负责在place_address指定的地址进行对象的初始化工作。

## 八、 能够直观地重新分配内存

使用malloc分配的内存后，如果在使用过程中发现内存不足，可以使用realloc函数进行内存重新分配实现内存的扩充。realloc先判断当前的指针所指内存是否有足够的连续空间，如果有，原地扩大可分配的内存地址，并且返回原来的地址指针；如果空间不够，先按照新指定的大小分配空间，将原有数据从头到尾拷贝到新分配的内存区域，而后释放原来的内存区域。

new没有这样直观的配套设施来扩充内存。



| 区别                   | new                                  | malloc                   |
| :--------------------- | :----------------------------------- | :----------------------- |
| 属性                   | 是关键字，也是运算符                 | 库函数                   |
| 申请空间               | 自由存储区                           | 堆空间                   |
| 返回类型（申请成功）   | 类型对象指针                         | void*                    |
| 返回类型（申请失败）   | 抛异常                               | nullptr                  |
| 参数（内存大小）       | 无需指定内存大小                     | 需要指定内存大小         |
| 是否可重载             | 可以                                 | 不支持                   |
| 能否直观地重新分配内存 | 无法直观处理                         | realloc完成              |
| 分配内存时内存不足     | 客户能够指定处理函数或重新制定分配器 | 无法通过用户代码进行处理 |
| 构造函数和析构函数     | 调用                                 | 不调用                   |

